</html><!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Post Office Visualization</title>
		<script type="text/javascript" src="./d3/d3.v2.js"></script>
		<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.29.5"></script>
   	 	<script type="text/javascript" src="http://polymaps.org/polymaps.min.js?2.5.0"></script>
   	 	<link href="postalSystem.css" rel="stylesheet" type="text/css" />
   	 	<link href='http://fonts.googleapis.com/css?family=Stoke' rel='stylesheet' type='text/css'>
	</head>
	<body>

		<div class="main-container">
			<div id="main_info">
					<p id="chosen">Year: </p>
					<p id="currentCounty"></p> 
			</div>
			<div id="county">
					
			</div>
			<div id="map"></div>
			<div id="time_slide">
				<p>1870</p>
				<input id="year" type="range" min="1870" max="1900" onchange="updateSlider(this.value)" />
				<p>1900</p>
			</div>
		</div>	

		<script type="text/javascript">


		//A lot of code based off Michael Bostock's website

		var w = 1280,
    		h = 800;

		var projection = d3.geo.azimuthal()
    				.mode("equidistant")
				    .origin([-98, 38])
				    .scale(1400)
				    .translate([640, 360]);

		var svg = d3.select("body").insert("svg:svg", "h2")
    				.attr("width", w)
    				.attr("height", h);

		var cells = svg.append("svg:g")
    		.attr("id", "cells");

    	/* slider variables */

    	var active = 0;
		var yearSlider = 1901;
		var data;

		function updateSlider(slideAmount) {
			var display1 = document.getElementById("year");
			//var display2 = document.getElementById("month");
			//var display3 = document.getElementById("day");

			var display = document.getElementById("chosen");


			display.innerHTML="YEAR:&nbsp;" + display1.value + "&nbsp;&nbsp;&nbsp;&nbsp;" + "POST OFFICES PRESENT:&nbsp;" + active;
			//display = document.getElementById("chosen2");
			//display.innerHTML="Month: " + display2.value;

			//display = document.getElementById("chosen3");
			//display.innerHTML="Day: " + display3.value;

			yearSlider = slideAmount;
			
			togglePoints(display1.value);
/*
			var positions = []
			d3.selectAll(".active")
			.each(function(d) {
				positions.push(transform(d));
			});*/

		}

		function togglePoints(year) {
			d3.selectAll("circle").each( function(d, i){
					var key = d3.select(this).attr("id");
    				var estabdate = data[key][7];
    				var estabnumbers = estabdate.split("/");
    				var distabdate = data[key][12];
    				var distabnumbers = distabdate.split("/");
    				if (estabnumbers[2] <= year && distabnumbers[2] >= year) {
    					d3.select(this)
    					.attr("class", "active")
    					
    					
    				}
    				else {
    					d3.select(this)
    					.attr("class", "inactive")
    					
    					
    					if (!estabnumbers[13] == false) {
    						var estabdate2 = estabnumbers[13];
    						var estabnumbers2 = estabdate2.split("/");
    						var distabdate2 = distabnumbers[14];
    						var distabnumbers2 = [];
    						distabnumbers2 = distabdate2.split("/");
    						if (estabnumbers2[2] <= year || (distabnumbers2.length < 1)) {
    							d3.select(this)
    							.attr("class", "active")
    					
    							
    							
    							if (distabnumbers2.length > 0) {
    								if (distabnumbers2[2] < year) {
    									d3.select(this)
    									.attr("class", "inactive")
    									
    								}	
    							}
    						}
    					}

    					if (!estabnumbers[15] == false) {
    						var estabdate2 = estabnumbers[15];
    						var estabnumbers2 = estabdate2.split("/");
    						var distabdate2 = distabnumbers[16];
    						var distabnumbers2 = [];
    						distabnumbers2 = distabdate2.split("/");
    						if (estabnumbers2[2] <= year || (distabnumbers2.length < 1)) {
    							d3.select(this)
    							.attr("class", "active")
    							if (estabnumbers2[2] == year) {

    							}
    					
    							
    							
    							if (distabnumbers2.length > 0) {
    								if (distabnumbers2[2] < year) {
    									d3.select(this)
    									 .attr("class", "inactive")
    									
    								}
    							}
    						}
    					}

    					if (!estabnumbers[17] == false) {
    						var estabdate2 = estabnumbers[17];
    						var estabnumbers2 = estabdate2.split("/");
    						var distabdate2 = distabnumbers[18];
    						var distabnumbers2 = [];
    						distabnumbers2 = distabdate2.split("/");
    						if (estabnumbers2[2] <= year || (distabnumbers2.length < 1)) {
    							d3.select(this)
    							.attr("class", "active")
    					
    							
    							if (distabnumbers2.length > 0) {
    								if (distabnumbers2[2] < year) {
    									d3.select(this)
    									.attr("class", "inactive")
    									
    								}
    							}
    						}
    					}

    				}
    			});
				
				d3.selectAll(".active")
				.style("fill", "blue")
				.style("display", "inline")
    			.transition().delay(2000).duration(5000).style("opacity", "100");
    			
				active = 0;
    			d3.selectAll(".active")
    			.each(
    				function() {
    					active += 1;
    				}
    			);

    			d3.selectAll(".inactive")
    			.style("fill", "red")
    			.transition().delay(250).duration(2000).style("opacity", "0");

    		//	d3.selectAll(".inactive")
			//	.style("display", "none")
		}

			
		var po = org.polymaps;
		
		// Create the map object, add it to #map…
		var map = po.map()
		    .container(d3.select("#map").append("svg:svg").node())
		    .zoom(8)
		    .add(po.interact());

		var defs = svg.append('svg:defs');
            defs.append('svg:pattern')
                .attr('id', 'marker')
                .attr('patternUnits', 'userSpaceOnUse')
                .attr('width', '6')
                .attr('height', '6')
                .append('svg:image')
                .attr('xlink:href', 'http://www.stanford.edu/~gdykho/node_star.svg')
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', 10)
                .attr('height', 10);

		
			// Add the CloudMade image tiles as a base layer…
			map.add(po.image()
			    .url(po.url("http://{S}tile.cloudmade.com"
			    + "/32f5d99edf3b457695b907a22823fafb" // http://cloudmade.com/register
			    + "/998/256/{Z}/{X}/{Y}.png")
			    .hosts(["a.", "b.", "c.", ""])));
			
			map.add(po.layer(overlay)
    			.tile(false));

			function overlay(tile, proj) {
				  proj = proj(tile);
				  var tl = proj.locationPoint({lon: -125.52, lat: 43.10}),
				      br = proj.locationPoint({lon: -112.6, lat: 31.20}),
				      image = tile.element = po.svg("image");
				  image.setAttribute("preserveAspectRatio", "none");
				  image.setAttribute("x", tl.x);
				  image.setAttribute("y", tl.y);
				  image.setAttribute("width", br.x - tl.x);
				  image.setAttribute("height", br.y - tl.y);
				  image.setAttribute("opacity", 0.4);
				  image.setAttributeNS("http://www.w3.org/1999/xlink", "href", "post_map_counties.png");
			}

			map.add(po.compass()
	    		.pan("none"));
			var years = [];
			for (var i=1870;i<=1900;i++)
			{ 
				years.push(i);
			}

			var days = [];
			for (var i=1;i<=31;i++)
			{ 
				days.push(i);
			}

			var months = [];
			for (var i=1;i<=12;i++)
			{ 
				months.push(i);
			}

			// Load the station data. When the data comes back, display it.
			function plotPoints(data) {
				// Insert our layer beneath the compass.
				  var layer = d3.select("#map svg").insert("svg:g", ".compass");

				  


				  // Add an svg:g for each post office.
				  var marker = layer.selectAll("g")
				      .data(d3.entries(data))
				      .enter().append("svg:g")
				      .attr("transform", transform)
				      .append("svg:circle")
				      .attr("r", 10)
				      .style("fill", "blue")
					  .style("opacity", "0")
				      .style("stroke", "black")
				      .style("stroke-opacity", 1)
				      .attr("id", function(d) {return d.key})
				      .style("display", "none")
    					.on("mousedown", function(d) {
    						


    						var name = d.key;

							var county = data[name][0]

							globalCounty = county;

    						d3.selectAll("circle")
							.attr("r", 10)

							d3.selectAll(".active")
							.style("fill","blue")

							d3.selectAll(".active").each(function(e) {
								for (var i = 0; i < 3; i++) {
										var check = data[e.key][i]

										if (check == county) {
											d3.select(this).style("fill", "green")
										}
									}
								}
							);
					        

    						d3.select(this)
					        .style("fill", "none")
					        .style("stroke", "black")
					        .style("stroke-opacity", 1e-6)
					        .style("stroke-width", 3)
					      .transition()
					        .duration(750)
					        .attr("r", 100)
					        .style("fill", "orange")
					        .style("stroke-opacity", 1)
					        var textcheck = name + "text"

					        d3.selectAll("text").each(function(e) {

										var check = e.key +"text"
										
										if (check == textcheck) {
											
											d3.select(this).style("display", "inline")
										}
									
								});
					        

					  })
    					.on("mouseover", function(d) {

							var name = d.key;

							var county = data[name][0]

							var display3 = document.getElementById("currentCounty");
							display3.innerHTML="COUNTY:&nbsp;" + county;

							d3.selectAll(".active").each(function(e) {
									for (var i = 0; i < 3; i++) {
										var check = data[e.key][i]

										if (check == county) {
											d3.select(this).style("fill", "green")
										}
									}
								}
							);
					  }).on("mouseout", function(d) {

					  		d3.selectAll("circle")
					  		.style("fill","blue")

					  		d3.selectAll("circle")
					  		.transition().duration(1000)
							.attr("r", 10)

							 d3.selectAll("text").style("display", "none")
							 
					  })
    					;

    				var layer2 = d3.select("#map svg").append("svg:g");
    				var name;
    				var marker2 = layer2.selectAll("g")
				      .data(d3.entries(data))
				      .enter().append("svg:g")
				      .attr("transform", transform2)
				      .append("svg:text")
				      .attr("class", function(d) {
				      	name = d.key;
				      	return d.key + "text"})
				      .text(function(d) { 
				      	
				      	return "Name: " + data[d.key][4] })
				      .attr("display", "none")
				      .attr("dy", ".35em")
    					.attr("text-anchor", "middle")
    					.style("font", "300 16px Garamond")
    					;

				 	var layer4 = d3.select("#map svg").append("svg:g");
    				var marker4 = layer4.selectAll("g")
				      .data(d3.entries(data))
				      .enter().append("svg:g")
				      .attr("transform", transform4)
				      .append("svg:text")
				      .attr("class", function(d) {
				      	name = d.key;
				      	return d.key + "text"})
				      .text(function(d) { 
				      	
				      	return "Established: " + data[d.key][7] })
				      .attr("display", "none")
				      .attr("dy", ".35em")
    					.attr("text-anchor", "middle")
    					.style("font", "300 16px Garamond")
    					;
				 



				  // Whenever the map moves, update the marker positions.
				  map.on("move", function() {
				    layer.selectAll("g").attr("transform", transform);
				    layer2.selectAll("g").attr("transform", transform2);
				    layer4.selectAll("g").attr("transform", transform4);
				  });

				function transform(d) {
				    d = map.locationPoint({lon: d.value[5], lat: d.value[6]});
				    return "translate(" + d.x + "," + d.y + ")";
				}

				function transform2(d) {
				    d = map.locationPoint({lon: d.value[5], lat: d.value[6]+0.15});
				    return "translate(" + d.x + "," + d.y + ")";
				}
				function transform3(d) {
				    d = map.locationPoint({lon: d.value[5], lat: d.value[6]+0.05});
				    return "translate(" + d.x + "," + d.y + ")";
				}
				function transform4(d) {
				    d = map.locationPoint({lon: d.value[5], lat: d.value[6]-0.15});
				    return "translate(" + d.x + "," + d.y + ")";
				}
		}

		d3.json("http://www.stanford.edu/~gdykho/postOffice.json", function(json) {
		  	data = json;
		  	plotPoints(json);
		});

		function drawVoronoi(p) {

			  // Compute the Voronoi diagram of post office' projected positions.
			console.log()
			var polygons = d3.geom.voronoi(p);

			var g = cells.selectAll("g")
			    .data(p)
			    .enter().append("svg:g");

			  g.append("svg:path")
			      .attr("class", "cell")
			      .attr("d", function(d, i) { return "M" + polygons[i].join("L") + "Z"; })
		}

		</script>
	</body>
</html>